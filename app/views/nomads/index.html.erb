<div class="navbar-placeholder"></div>

<div id="map" style="width: 100%; height: 94vh;"></div>

<div class="nomad-count">
  <h1> <%= @nomads.count %> NOMADS </h1>
</div>

<!-- MAPS SCRIPT -->
<% content_for(:after_js) do %>

  <script>
    const mapContainer = document.querySelector('#map');
    const mapOptions = {
      zoom: 13,
      center: new google.maps.LatLng(<%= current_nomad.latitude %>, <%= current_nomad.longitude %>),
      styles: <%= render 'map_style.js' %>,
      scrollwheel: false
    };

    const clusterOptions = {
      // gridSize: 30,
      // maxZoom: 20,
    };

    // initializing variables
    const nomads = [];
    var infowindow = new google.maps.InfoWindow();
    var lastClicked = infowindow;

    function initMap() {
      const map = new google.maps.Map(mapContainer, mapOptions);


      // Populating the nomads array with JSON
      <% @nomads.each do |nomad| %>
        var nomad = {
          id: <%= nomad.id %>,
          first_name: "<%= nomad.first_name %>",
          last_name: "<%= nomad.last_name %>",
          link: "<%= nomad_url(nomad) %>",
          photo: "<%= image_url('avatar') %>",
          icon: "<%= set_icon(nomad) %>",
          lat: <%= nomad.latitude %>,
          lgn: <%= nomad.longitude %>,
        }
        nomads.push(nomad);
      <% end %>


      // Function to add a marker
      function createNomadMarker(object) {
        return new google.maps.Marker({
          position: new google.maps.LatLng(object.lat, object.lgn),
          icon: object.icon,
          id: object.id,
          map: map
        });
      };

      function centerMap(LatLng) {
        // var mapCenter = map.getCenter().toJSON();
        // var markerPosition = LatLng.toJSON();
        // var a = Math.round(Math.abs(mapCenter.lng - markerPosition.lng));
        // var b = Math.round(Math.abs(mapCenter.lat - markerPosition.lat));
        map.setCenter(LatLng);
      }

      function getMarkerPosition() {
        var position = this.getPosition();
        window.setTimeout( function() { centerMap(position) }, 200);
      };

      function createInfoWindow() {
        if (this.id !== <%= current_nomad.id %>) {
          lastClicked.close();
          var i = this.id;
          lastClicked = infowindow[i];
          lastClicked.open(map, this);
        };
      };


      // Populating the map with markers
      const nomadMarkers = nomads.map(nomad => createNomadMarker(nomad));


      // Creating content
      nomads.forEach(nomad => {
        if (nomad.id !== <%= current_nomad.id %>) {
          var i = nomad.id;
          infowindow[i] = new google.maps.InfoWindow({
            content:
            `<div class="iw">` +
              `<img src="${nomad.photo}" alt="${nomad.first_name}">` +
              `<h3 class="iw-name "> ${nomad.first_name} </h3>` +
              `<a href="${nomad.link}"> Messsage ${nomad.first_name} </a>` +
            `</div>`
          });
        };
      });

      // event listener on markers
      nomadMarkers.forEach(marker => marker.addListener( 'click', getMarkerPosition));
      nomadMarkers.forEach(marker => marker.addListener('click', createInfoWindow));



      // Creating marker clusters
      const markerClusterer = new MarkerClusterer(map, nomadMarkers, clusterOptions);

    }

    document.addEventListener('DOMContentLoaded', initMap);
  </script>

<% end %>

<!-- https://chrome.google.com/webstore/detail/french-digital-nomads-map/aaokjnbicmobnkgjnmbmffbnldebhgfa -->
